<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Re:direct</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6" id="themeColor">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --background: #ffffff;
            --surface: #f8fafc;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
        }
        .dark-theme {
            --background: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;
            background-color:var(--background); color:var(--text-primary); line-height:1.6;
            transition:background-color .3s ease,color .3s ease; display:flex; flex-direction:column; min-height:100vh;
        }
        .container { max-width:800px; margin:0 auto; padding:20px; width:100%; flex-grow:1; display:flex; flex-direction:column; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:20px; }
        .logo { font-size:24px; font-weight:bold; color:var(--primary-color); }
        .controls { display:flex; gap:15px; align-items:center; }
        .btn {
            padding:8px 16px; border:1px solid var(--border); border-radius:var(--radius); background:var(--surface);
            color:var(--text-primary); cursor:pointer; transition:all .2s ease; font-size:14px; text-decoration:none;
            display:inline-flex; align-items:center; justify-content:center; gap:8px; white-space:nowrap;
        }
        .btn:hover { background:var(--border); }
        .btn-primary { background:var(--primary-color); color:#fff; border-color:var(--primary-color); }
        .btn-primary:hover { background:var(--primary-hover); border-color:var(--primary-hover); }
        .btn-icon { padding:8px; min-width:40px; justify-content:center; }
        .w-6 { width:1.5rem; } .h-6 { height:1.5rem; }
        .card {
            background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
            overflow:hidden; padding:24px; text-align:center; max-width:480px; width:100%; margin:auto;
        }
        .app-header { display:flex; align-items:center; gap:16px; margin-bottom:20px; justify-content:center; }
        .app-icon { width:48px; height:48px; border-radius:var(--radius); background:var(--primary-color); display:flex;
            align-items:center; justify-content:center; color:white; flex-shrink:0; }
        .app-icon svg { width:28px; height:28px; }
        .app-name { font-weight:600; font-size:20px; }
        .redirect-info { color:var(--text-secondary); font-size:16px; margin-bottom:16px; }
        .timer-container { display:flex; justify-content:center; align-items:baseline; gap:8px; font-size:20px; font-weight:500; margin-bottom:20px; }
        .timer { font-size:24px; font-weight:600; color:var(--primary-color); }
        .obtainium-info { font-size:14px; color:var(--text-secondary); margin-bottom:16px; }
        .download-buttons { display:flex; gap:16px; justify-content:center; margin-top:16px; flex-wrap:wrap; }
        .footer { text-align:center; padding:20px; color:var(--text-muted); font-size:14px; border-top:1px solid var(--border); margin-top:40px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; padding:20px; }
        .modal.active { display:flex; }
        .modal-content { background:var(--surface); border-radius:var(--radius); max-width:400px; width:100%; box-shadow:var(--shadow-lg); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid var(--border); }
        .modal-title { font-size:18px; font-weight:600; }
        .modal-close { background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary); }
        .modal-body { padding:20px; }
        .step { margin-bottom:24px; } .step:last-child { margin-bottom:0; }
        .step-title { font-weight:600; margin-bottom:12px; }
        .step-buttons { display:flex; gap:8px; flex-wrap:wrap; }
        .step-buttons .btn { flex:1; }
        @media (max-width:768px){
            .logo{font-size:20px;} .btn-text{display:none;} .step-buttons{flex-direction:column;}
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="logo">k0sha VPN</div>
        <div class="controls">
            <button class="btn btn-icon" onclick="openModal('settingsModal')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="btn-text" data-key="settings">Settings</span>
            </button>
        </div>
    </header>

    <main>
        <div id="redirectCard" class="card">
            <div class="app-header">
                <div class="app-icon" id="appIcon"></div>
                <h2 class="app-name" id="appName"></h2>
            </div>
            <p class="redirect-info" id="redirectText"></p>
            <div id="timerSection" style="display:none;">
                <p class="redirect-info" data-key="you_will_be_redirected"></p>
                <div class="timer-container">
                    <span id="timer" class="timer">10</span>
                    <span id="secondsText"></span>
                </div>
            </div>
            <p class="redirect-info" id="afterTimerText"></p>
            <div id="obtainiumSection" class="obtainium-info" style="display:none;">
                <p id="obtainiumText"></p>
                <div id="obtainiumDownloads" class="download-buttons"></div>
            </div>
            <a id="proceedBtn" class="btn btn-primary" href="#" style="display:none;" target="_self">
                <span id="proceedBtnText" data-key="proceed"></span>
            </a>
        </div>
    </main>
</div>

<footer class="footer">created ❤️ by legiz</footer>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" data-key="settings">Settings</h3>
            <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="step">
                <div class="step-title" data-key="theme">Theme</div>
                <div class="step-buttons">
                    <button class="btn" onclick="setTheme('light')" data-key="light">Light</button>
                    <button class="btn" onclick="setTheme('dark')" data-key="dark">Dark</button>
                    <button class="btn" onclick="setTheme('auto')" data-key="auto">Auto</button>
                </div>
            </div>
            <div class="step">
                <div class="step-title" data-key="language">Language</div>
                <div class="step-buttons">
                    <button class="btn" onclick="setLanguage('en')">English</button>
                    <button class="btn" onclick="setLanguage('ru')">Русский</button>
                    <button class="btn" onclick="setLanguage('fa')">فارسی</button>
                    <button class="btn" onclick="setLanguage('zh')">中文</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ОБЪЕКТЫ ДАННЫХ ---
    const appIcons = {
        'happ': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M13.4,19.6l-7.9,7.9L5,30.4h6.6L13.4,19.6z" /><path d="M13.2,13.5L14.6,5l-7.9,7.9L4.2,27.4l7.9-7.9l0.2-1.2h1l4.9-4.9H13.2z" /><path d="M25.4,19.6L27.8,5l-7.9,7.9l-0.1,0.7h-0.6l-4.9,4.9h4.7l-1.5,9L25.4,19.6z" /><path d="M18.7,27.5l-0.5,2.9h6.6l1.8-10.8L18.7,27.5z" /><path d="M13.6,4.9l0.6-3.3H7.5L5.6,12.8L13.6,4.9z" /><path d="M18.8,12.8l7.9-7.9l0.6-3.3h-6.6L18.8,12.8z" /></svg>`,
        'sing-box': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M28.845 22.699c.608-.37.998-1.235 1-1.854V11.2s.008-.403-.417-.673L16.825 2.649s-1.48-.95-2.921 0L2.407 10.324c-.536.37-.558 1.036-.558 1.036l-.004 9.339s-.013 1.171.5 1.5l12.5 8 .048-11-12.158-7.694s-.556-.351.158-.76L14.345 3.2c1.032-.628 2.06-.03 2.06-.03l12.556 7.687c.604.254.158.444.158.444l-2.849 1.805s-.404.357-.888.112L12.356 5.134l-.48.316 13.47 8.249v3.5a.93.93 0 0 1-.362.745л-3.777 2.515s-.348.25-.362-.26v-3.5L7.43 8.359l-.542.369 13.036 8.158s.384.207-.056.446l-3.32 1.982v9.885s-.002.637-.702 1c0 0 .521.128 1.467-.432z"/></svg>`,
        'streisand': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M19.744 7.308..."/></svg>`,
        'shadowrocket': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M26.76 23.819..."/></svg>`,
        'clash-meta': `<svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.1 35.17H5.686m9.282 2.993l-8.846 3.163M24 16.874c.801 0 2.551.256 2.551.256L37.746 6.674s3.295.341 4.754.852V31.63c-1.42.653-4.574 1.108-6.45 1.108V17.11l-7.756 7.302S25.708 23.560 24 23.560s-4.294.853-4.294.853L11.95 17.11v15.627c-1.876 0-5.03-.455-6.45-1.108V7.526c1.458-.511 4.754-.852 4.754-.852L21.45 17.13s1.75-.256 2.551-.256m.625 17.245L24 35.265l-.626-1.146M32.9 35.17h9.414m-9.282 2.993l8.846 3.163"/></svg>`,
        'v2rayng': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M0 1.86298V3.72596..."/></svg>`,
        'clash-verge-rev': `<svg viewBox="0 0 22 22" fill="currentColor"><path d="M11.007 22C6.01025 22 0.413848..."/></svg>`,
        'flclash': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M15.215 31.645..."/></svg>`,
        'hiddify': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M26.8191 2.1691..."/></svg>`,
        'exclave': `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M10.238 28.828..."/></svg>`,
        'obtainium': `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6,18c0,0.55..."/></svg>`,
        "default": `<svg viewBox="0 0 32 32" fill="currentColor"><rect width="32" height="32" rx="8" fill="#3b82f6"/><path d="M22.667 10.667L13.333 20l-5.333-5.333 1.88-1.88 3.453 3.453 7.454-7.453 1.88 1.88z" fill="#fff"/></svg>`
    };

    const appSchemes = [
        {scheme: 'happ://', id: 'happ', name: {en:'Happ', ru:'Happ', fa:'Happ', zh:'Happ'}},
        {scheme: 'flclash://', id: 'flclash', name: {en:'FlClash', ru:'FlClash', fa:'FlClash', zh:'FlClash'}},
        {scheme: 'clash://', id: 'clash-meta', name: {en:'Clash', ru:'Clash', fa:'Clash', zh:'Clash'}},
        {scheme: 'sing-box://', id: 'sing-box', name: {en:'sing-box', ru:'sing-box', fa:'sing-box', zh:'sing-box'}},
        {scheme: 'streisand://', id:'streisand', name:{en:'Streisand', ru:'Streisand', fa:'Streisand', zh:'Streisand'}},
        {scheme: 'v2rayng://', id:'v2rayng', name:{en:'v2rayNG', ru:'v2rayNG', fa:'v2rayNG', zh:'v2rayNG'}},
        {scheme: 'exclave://', id:'exclave', name:{en:'Exclave', ru:'Exclave', fa:'Exclave', zh:'Exclave'}},
        {scheme: 'sub://', id:'shadowrocket', name:{en:'Shadowrocket', ru:'Shadowrocket', fa:'Shadowrocket', zh:'Shadowrocket'}},
        {scheme: 'hiddify://', id:'hiddify', name:{en:'Hiddify', ru:'Hiddify', fa:'Hiddify', zh:'Hiddify'}},
        {scheme: 'obtainium://', id:'obtainium', name:{en:'Obtainium', ru:'Obtainium', fa:'Obtainium', zh:'Obtainium'}}
    ];

    const translations = {
        en:{settings:"Settings",theme:"Theme",language:"Language",light:"Light",dark:"Dark",auto:"Auto",seconds:"seconds",
            redirecting_to:"Redirecting to",you_will_be_redirected:"You will be redirected automatically in",if_not:"If nothing happens, click the button below.",
            proceed:"Import",error_redirect:"Redirection Error",error_description:"The redirection link is missing or invalid.",
            obtainium_info:"If this didn't happen, you may not have the Obtainium app installed. Download it from GitHub or F-Droid and try clicking the Import button below.",
            download_github:"Download (GitHub)",download_fdroid:"Download (F-Droid)"},
        ru:{settings:"Настройки",theme:"Тема",language:"Язык",light:"Светлая",dark:"Тёмная",auto:"Авто",seconds:"секунд",
            redirecting_to:"Перенаправление в",you_will_be_redirected:"Вы будете автоматически перенаправлены через",if_not:"Если этого не произошло, нажмите кнопку ниже.",
            proceed:"Импортировать",error_redirect:"Ошибка перенаправления",error_description:"Ссылка для перенаправления отсутствует или недействительна.",
            obtainium_info:"Если этого не произошло, возможно у вас не загружено приложение Obtainium. Загрузите его в GitHub или F-Droid и попробуйте нажать кнопку Импортировать ниже.",
            download_github:"GitHub",download_fdroid:"F-Droid"},
        fa:{settings:"تنظیمات",theme:"پوسته",language:"زبان",light:"روشن",dark:"تیره",auto:"خودکار",seconds:"ثانیه",
            redirecting_to:"در حال هدایت به",you_will_be_redirected:"شما به طور خودکار هدایت خواهید شد در",if_not:"اگر اتفاقی نیفتاد، دکمه زیر را کلیک کنید.",
            proceed:"وارد کردن",error_redirect:"خطای هدایت",error_description:"لینک هدایت وجود ندارد یا نامعتبر است.",
            obtainium_info:"اگر این اتفاق نیفتاد، ممکن است برنامه Obtainium را نصب نکرده باشید. آن را از GitHub یا F-Droid دانلود کرده و روی دکمه وارد کردن در پایین کلیک کنید.",
            download_github:"دانلود (GitHub)",download_fdroid:"دانلود (F-Droid)"},
        zh:{settings:"设置",theme:"主题",language:"语言",light:"浅色",dark:"深色",auto:"自动",seconds:"秒",
            redirecting_to:"正在重定向到",you_will_be_redirected:"您将在以下时间后自动重定向",if_not:"如果没有任何反应，请单击下面的按钮。",
            proceed:"导入",error_redirect:"重定向错误",error_description:"重定向链接丢失或无效。",
            obtainium_info:"如果重定向没有发生，您可能没有安装 Obtainium 应用程序。请从 GitHub 或 F-Droid 下载它，然后点击下方的“导入”按钮。",
            download_github:"下载 (GitHub)",download_fdroid:"下载 (F-Droid)"}
    };

    // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
    let currentLanguage = 'ru';
    let timerValue = 10;
    let timerId = null;
    let redirectTo = "";
    let appInfo = null;

    // --- ОСНОВНЫЕ ФУНКЦИИ ---
    document.addEventListener("DOMContentLoaded", function () { initialize(); });

    function getTarget() {
        const u = new URL(location.href);
        let t = u.searchParams.get('redirect_to');
        if (t) { try { t = decodeURIComponent(t); } catch(_) {} }
        if (!t && u.hash) {
            try { t = decodeURIComponent(u.hash.slice(1)); } catch(_) { t = u.hash.slice(1); }
        }
        if (t) t = t.replace(/&amp;/g, '&');
        return t || '';
    }

    function initialize() {
        loadSettings();

        redirectTo = getTarget();
        appInfo = appSchemes.find(a => redirectTo.startsWith(a.scheme));

        updateUI();
        startTimer();

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('theme') === 'auto') applyTheme('auto');
        });
        document.addEventListener('click', e => {
            if (e.target.classList.contains('modal')) closeModal('settingsModal');
        });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal('settingsModal'); });
    }

    function updateUI() {
        updateAllTexts();

        const appIconEl = document.getElementById("appIcon");
        const appNameEl = document.getElementById("appName");
        const redirectTextEl = document.getElementById("redirectText");
        const timerSection = document.getElementById("timerSection");
        const afterTimerText = document.getElementById("afterTimerText");
        const obtainiumSectionEl = document.getElementById("obtainiumSection");
        const proceedBtn = document.getElementById("proceedBtn");

        if (!redirectTo) {
            appIconEl.innerHTML = appIcons["default"];
            appNameEl.textContent = t("error_redirect");
            redirectTextEl.textContent = t("error_description");
            timerSection.style.display = "none";
            afterTimerText.style.display = "none";
            obtainiumSectionEl.style.display = "none";
            proceedBtn.style.display = "none";
        } else {
            const appId = appInfo ? appInfo.id : "default";
            const appName = appInfo ? appInfo.name[currentLanguage] || appInfo.name['en'] : "App";

            appIconEl.innerHTML = (appIcons[appId] || appIcons["default"]);
            appNameEl.textContent = appName;
            redirectTextEl.textContent = `${t("redirecting_to")} ${appName}...`;

            timerSection.style.display = "block";
            proceedBtn.style.display = "inline-flex";
            proceedBtn.href = redirectTo;
            proceedBtn.target = "_self";

            if (appInfo && appInfo.id === 'obtainium') {
                afterTimerText.style.display = "none";
                obtainiumSectionEl.style.display = "block";
                document.getElementById("obtainiumText").textContent = t("obtainium_info");
                const downloadsEl = document.getElementById("obtainiumDownloads");
                downloadsEl.innerHTML = `
                    <a href="https://github.com/ImranR98/Obtainium/releases/latest/download/app-release.apk" class="btn btn-primary" target="_blank">${t('download_github')}</a>
                    <a href="https://f-droid.org/packages/dev.imranr.obtainium.fdroid/" class="btn btn-primary" target="_blank">${t('download_fdroid')}</a>
                `;
            } else {
                afterTimerText.style.display = "block";
                obtainiumSectionEl.style.display = "none";
            }
        }
    }

    function startTimer() {
        if (!redirectTo || timerId) return;

        const timerEl = document.getElementById("timer");
        timerEl.textContent = timerValue;

        // попытка мгновенного открытия
        setTimeout(() => { location.replace(redirectTo); }, 60);

        // визуальный таймер как запасной сценарий
        timerId = setInterval(() => {
            timerValue--;
            timerEl.textContent = timerValue;
            if (timerValue <= 0) {
                clearInterval(timerId);
                location.replace(redirectTo);
            }
        }, 1000);

        // если блокируется и пользователь вернулся — показать ссылку
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const afterTimerText = document.getElementById("afterTimerText");
                afterTimerText.innerHTML = `<u><a href="${redirectTo}">Открыть настройки</a></u>`;
            }
        });
    }

    // --- ФУНКЦИИ НАСТРОЕК (ТЕМА И ЯЗЫК) ---
    function loadSettings() {
        const savedTheme = localStorage.getItem('theme') || 'auto';
        applyTheme(savedTheme);
        const savedLang = localStorage.getItem('lang') || getBrowserLanguage();
        setLanguage(savedLang, false);
    }
    function getBrowserLanguage() {
        const lang = navigator.language || navigator.userLanguage;
        if (lang.startsWith('ru')) return 'ru';
        if (lang.startsWith('fa')) return 'fa';
        if (lang.startsWith('zh')) return 'zh';
        return 'en';
    }
    function setTheme(theme) { localStorage.setItem('theme', theme); applyTheme(theme); }
    function applyTheme(theme) {
        const html = document.documentElement;
        const themeColorMeta = document.getElementById('themeColor');
        const isDark = (theme === 'auto') ? window.matchMedia('(prefers-color-scheme: dark)').matches : (theme === 'dark');
        html.classList.toggle('dark-theme', isDark);
        themeColorMeta.setAttribute('content', isDark ? '#0f172a' : '#3b82f6');
    }
    function setLanguage(lang, shouldUpdateUI = true) {
        currentLanguage = lang;
        localStorage.setItem('lang', lang);
        document.documentElement.lang = lang;
        if (shouldUpdateUI) updateUI();
    }
    function t(key) { return translations[currentLanguage]?.[key] || translations.en[key] || key; }
    function updateAllTexts() {
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            const text = t(key);
            const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim());
            if (textNode) textNode.textContent = text;
            else if (el.children.length === 0) el.textContent = text;
        });
        document.querySelector('.logo').textContent = "k0sha VPN";
        document.getElementById("secondsText").textContent = t("seconds");
        document.getElementById("afterTimerText").textContent = t("if_not");
    }

    // --- УПРАВЛЕНИЕ МОДАЛЬНЫМИ ОКНАМИ ---
    function openModal(id) { document.getElementById(id)?.classList.add('active'); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
</script>
</body>
</html>
